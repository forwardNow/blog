# webpack 原理分析

## 1. loader

### 1.1. 介绍

#### 1.1.1. 概念

帮助 webpack 将不同类型的文件转换为 webpack 可识别的模块

参考：[loaders](https://webpack.js.org/concepts/loaders/)

#### 1.1.2. 分类

| category | desc      |
|----------|-----------|
| pre      | 前置 loader |
| normal   | 普通 loader |
| inline   | 内联 loader |
| post     | 后置 loader |

#### 1.1.3. 执行顺序

说明：

* 相同类别的 loader 执行顺序： 从右到左，从下到上
* 不同类别的 loader 执行顺序： `pre > normal > inline > post`

示例1：

```javascript
// 此时 loader 执行顺序：loader3 - loader2 - loader1
module.exports = {
  module: {
    rules: [
      { 
        test: /\.css$/, 
        use: [ 'loader1', 'loader2', 'loader3' ]
      },
    ],
  },
};
```

示例2：

```javascript
// 此时 loader 执行顺序：loader3 - loader2 - loader1
module.exports = {
  module: {
    rules: [
      { test: /\.jsx$/, loader: 'loader1' },
      { test: /\.css$/, loader: 'loader2' },
      { test: /\.jpg$/, loader: 'loader3' },
    ],
  },
};
```

示例3:

```javascript
// 此时 loader 执行顺序：loader1 - loader2 - loader3
module.exports = {
  module: {
    rules: [
      { test: /\.jsx$/, loader: 'loader1', enforce: 'pre' },  // 前置 loader
      { test: /\.css$/, loader: 'loader2' },                  // 普通 loader
      { test: /\.jpg$/, loader: 'loader3', enforce: 'post' }, // 后置 loader
    ],
  },
};
```

#### 1.1.4. 使用方式

* 配置方式，指定 pre、normal、post loader
* 内联方式，指定 inline loader

##### 1.1.4.1. 配置方式

说明：

* 在 webpack.config.js 中配置 module.rules.Rule 即可

示例：

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.jsx$/,
        loader: 'loader1',
        enforce: 'pre'
      },
    ],
  },
};
```

##### 1.1.4.2. 内联方式

说明：

* inline loader （内联 loader）
* 在 `import` 语句中指定用哪些 loader 来处理这个模块，指定的那些 loader 都是 inline loader

示例1.  `import 'style-loader!css-loader?modules!./styles.css';`

* 使用 `style-loader`、`css-loader` 处理 `./styles.css` 模块
* `css-loader?modules` 中的 `?modules` 是 query string（查询字符串）
* 各个部分（loader、资源路径）之间用 `!` 分隔

示例2. `import '!style-loader!css-loader?modules!./styles.css';`

* 打头的前缀 `!`，表示跳过 normal loader
* 也就是说，跳过其它也能处理这个文件的 普通 loader （webpack.config.js 中配置的）

示例3. `import '-!style-loader!css-loader?modules!./styles.css';`

* 打头的前缀 `-!`，表示跳过 pre、normal loader

示例4. `import '!!style-loader!css-loader?modules!./styles.css';`

* 打头的前缀 `!!`，表示跳过 pre、normal、post loader

### 1.2. 第一个 loader

目录:

```text
proj/
  loaders/
    my-first-loader.js
  public/
    index.html
  src/
    main.js
  package.json
  webpack.config.js
```

配置：

```javascript
module.exports = {
  // ...
  module: {
    rules: [
      { test: /\.js$/, loader: './loaders/my-first-loader.js' }
    ],
  },
}
```

my-first-loader.js:

```javascript
/**
 * @param {string|Buffer} content Content of the resource file
 * @param {object} map SourceMap data consumable by https://github.com/mozilla/source-map
 * @param {any} meta Meta data, could be anything, 别的 loader 传递的数据
 * @return {string}
 */
function myFirstLoader(content, map, meta) {
  console.log('hello, my first loader!');
  return content;
}

module.exports = myFirstLoader;
```

参考：

* [loaders#examples](https://webpack.js.org/api/loaders#examples)

### 1.3. loader 分类

1. 同步 loader (Synchronous Loaders)
2. 异步 loader (Asynchronous Loaders)
3. "Raw" Loader
4. Pitching Loader

#### 1.3.1. 同步 loader

方式一：

```javascript
module.exports = function (content, map, meta) {
  const transformedContent = someSyncOperation(content, map, meta)
  return transformedContent;
};
```

方式二：

```javascript
module.exports = function (content, map, meta) {
  /*
    第一个参数：(err)         代表是否有错误
    第二个参数：(content)     处理后的内容
    第三个参数：(source-map)  继续传递 source-map
    第四个参数：(meta)        给下一个 loader 传递参数
  */
  this.callback(null, content, map, meta);
  return; // always return undefined when calling callback()
};
```

参考：[loaders#synchronous-loaders](https://webpack.js.org/api/loaders#synchronous-loaders)

#### 1.3.2. 异步 loader

```javascript
module.exports = function (content, map, meta) {
  const callback = this.async();
  
  setTimeout(() => {
    const transformedContent = someSyncOperation(content, map, meta)
    
    // 参数列表与 this.callback 相同
    callback(null, transformedContent, map, meta);
  }, 1000)
};
```

参考：[loaders/#asynchronous-loaders](https://webpack.js.org/api/loaders/#asynchronous-loaders)

#### 1.3.3. "Raw" Loader

说明：

* 可以使用异步、同步操作
* 接收 Buffer 数据，通常用于处理媒体文件（图片等）

示例：

```javascript
module.exports = function rawLoader(content) {
  assert(content instanceof Buffer);
  return someSyncOperation(content);
  // return value can be a `Buffer` too, This is also allowed if loader is not "raw"
};

// raw 属性也可以设置在函数对象(rawLoader)上
module.exports.raw = true;
```

参考：

* [loaders/#raw-loader](https://webpack.js.org/api/loaders/#raw-loader)
