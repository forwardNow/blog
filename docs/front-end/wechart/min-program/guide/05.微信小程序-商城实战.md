# 微信小程序-商城实战

## 1. 起步

### 1.1. uni-app

uni-app 是一个使用 Vue.js 开发所有前端应用的框架

开发者编写一套代码，可发布到：

* iOS
* Android
* Web（响应式）
* 各种小程序（微信/支付宝/百度/头条/飞书/QQ/快手/钉钉/淘宝）
* 快应用

### 1.2. HBuilderX

说明：

* 推荐使用 [HBuilderX](https://www.dcloud.io/hbuilderx.html) 开发工具
* 好处：模板丰富，完善的智能提示，一键运行

安装 scss 编译插件：

* 地址：[https://ext.dcloud.net.cn/plugin?id=2046](https://ext.dcloud.net.cn/plugin?id=2046)

### 1.3. 新建 uni-app 项目

步骤：

1. 文件(菜单) -> 新建 -> 1.项目
2. uni-ui 项目模板
3. vue.js v2

### 1.4. 目录结构

一个 uni-app 项目，默认包含如下目录及文件：

```text
┌─components uni-app组件目录
│ └─comp-a.vue 可复用的a组件
├─pages 业务页面文件存放的目录
│ ├─index
│ │ └─index.vue index页面
│ └─list
│ └─list.vue list页面
├─static 存放应用引用静态资源（如图片、视频等）的目录，注意：静态资源只能存放于此
├─main.js Vue初始化入口文件
├─App.vue 应用配置，用来配置小程序的全局样式、生命周期函数等
├─manifest.json 配置应用名称、appid、logo、版本等打包信息
└─pages.json 配置页面路径、页面窗口样式、tabBar、navigationBar 等页面类信息
```

### 1.5. 运行到微信开发者工具

1.在项目的微信小程序配置，填写 appid：

* 位置：`uni-app 项目/manifest.json`
* 源码视图：

    ```json
    {
      // 对应 project.config.json 配置文件
      "mp-weixin" : {
        "appid" : "wx1fe40ee133fd4afb",
        "setting" : {
            "urlCheck" : false
        },
        "usingComponents" : true
      },
    }
    ```

2.在运行配置中，添加微信开发者工具安装目录：

* 位置：工具（菜单）-> 设置
* 源码视图：

    ```json
    {
        "editor.colorScheme" : "Atom One Dark",
        "editor.fontSize" : 14,
        "editor.insertSpaces" : true,
        "editor.tabSize" : 2,
        "editor.showDefaultEndOfLine" : "\\n",

        // 微信开发者工具安装目录
        "weApp.devTools.path" : "C:\\install\\微信web开发者工具"
    }
    ```

3.开启微信开发者工具的服务端口：

* 位置：设置 -> 安全（页签）

4.运行

* 选中项目根目录
* 运行（菜单）-> 运行到小程序模拟器 -> 微信开发者工具

### 1.6. 使用 git 管理项目

.gitignore:

```text
/.idea
/node_modules
/unpackage/dist
```

注意：

* 如果一个目录里没有文件，git 是不会追踪的
* 创建 `/unpackage/.gitkeep` 空白文件，让 git 可以追踪到 unpackage 目录

## 2. tabBar

### 2.1. 新建页面

步骤：

1. 选择 `uni-shop/pages` 目录
2. 右键菜单：新建 uni-app 页面
3. 勾选 “创建同名目录”、“在 pages.json 中注册”

注意：

* 删除页面时，需要同时删除 `pages.json` 中对应页面的配置

### 2.2. 配置 tabBar

1. 将 icon 等图片资源放入 `uni-shop/static` 目录
2. 在 `[uni-shop/pages.json].tabBar` 中配置 tabBar 页面

    ```json
    {
      "tabBar": {
        "selectedColor": "#C00000",
        "list": [
          {
            "pagePath": "pages/home/home",
            "text": "首页",
            "iconPath": "static/tab_icons/home.png",
            "selectedIconPath": "static/tab_icons/home-active.png"
          },
          {
            "pagePath": "pages/cate/cate",
            "text": "分类",
            "iconPath": "static/tab_icons/cate.png",
            "selectedIconPath": "static/tab_icons/cate-active.png"
          },
          {
            "pagePath": "pages/cart/cart",
            "text": "购物车",
            "iconPath": "static/tab_icons/cart.png",
            "selectedIconPath": "static/tab_icons/cart-active.png"
          },
          {
            "pagePath": "pages/my/my",
            "text": "我的",
            "iconPath": "static/tab_icons/my.png",
            "selectedIconPath": "static/tab_icons/my-active.png"
          }
        ]
      }
    }
    ```

### 2.3. 修改导航条的样式

在 `[uni-shop/pages.json].globalStyle` 设置导航条样式：

```json
{
  "globalStyle": {
    "navigationBarTextStyle": "white",
    "navigationBarTitleText": "优购商城",
    "navigationBarBackgroundColor": "#C00000",
    "backgroundColor": "#FFFFFF"
  }
}
```

## 3. 首页

### 3.1. 配置网络请求

说明：

* 使用 uni-ajax 封装请求
* 文档：

    * [UNI-AJAX —— 官方文档](https://uniajax.ponjs.com/)
    * [DCloud - 插件市场 - request uni-ajax 请求](https://ext.dcloud.net.cn/plugin?id=2351)

安装：(使用 npm 安装)

```shell
npm init -y

npm i uni-ajax

## "uni-ajax": "^2.5.1"
```

使用：

* `/commons/http/http.js`:

    ```javascript
    import uniAjax from 'uni-ajax'

    const config = {
      baseURL: 'https://api-hmugo-web.itheima.net'
    };

    const http = uniAjax.create(config);

    // 添加请求拦截器
    http.interceptors.request.use(
      (config) => {
        uni.showLoading({
          title: '数据加载中...'
        })
        return config;
      },
      (error) => {
        return Promise.reject(error)
      }
    );

    // 添加响应拦截器
    instance.interceptors.response.use(
      (response) => {
        uni.hideLoading();
        return response.data;
      },
      (error) => {
        return Promise.reject(error)
      }
    )

    export default http;
    ```

* `/main.js`:

    ```javascript
    import http from './commons/http/http';

    // 挂在到全局变量 uni
    uni.$http = http;
    ```

### 3.2. API 文档

![https://www.showdoc.com.cn/128719739414963/2513235043485226](https://www.showdoc.com.cn/128719739414963/2513235043485226)


### 3.3. 轮播图

#### 3.3.1. 请求数据

```javascript
export default {
  onLoad() {
    this.getSwiperList();
  },
  
  data() {
    return {
      swiperList: [],
    };
  },
  
  methods: {
    async getSwiperList() {
      // API 文档： https://www.showdoc.com.cn/128719739414963/2513235043485226
      const { message: swiperList } = await uni.$http.get('/api/public/v1/home/swiperdata');
      
      this.swiperList = swiperList;
    },
  },
}
```

#### 3.3.2. 界面

在 HBuilderX 的编辑器中，输入 `uswiper` 即可触发代码片段选择框，选择即可

#### 3.3.3. 配置分包

步骤：

1. 创建目录 `/subpkg`
2. 配置 `[pages.json].subPackages` 节点：

    ```json
    {
      "subPackages": [
        {
          "root": "subpkg",
          "pages": []
        }
      ],
    }
    ```

3. 新建页面 `goods_detail`，选择 `subpkg` 分包，创建完毕后的 `pages.json` 配置：

    ```json
    {
      "subPackages": [
        {
          "root": "subpkg",
          "pages": [
            {
              "path": "goods_detail/goods_detail",
              "style": {
                "navigationBarTitleText": "",
                "enablePullDownRefresh": false
              }
            }
          ]
        }
      ],
    }
    ```

#### 3.3.4. 点击后跳转详情页

```html
<navigator 
  class="swiper-item" 
  :url="`/subpkg/goods_detail/goods_detail?goods_id=${item.goods_id}`"
>
  <image :src="item.image_src"></image>
</navigator>
```

### 3.4. 分类导航

跳转 tabBar 页面：

```javascript
uni.switchTab({ url: 'navigator_url' });
```


### 3.5. 参考

* [api/ui/prompt.html#showloading](https://zh.uniapp.dcloud.io/api/ui/prompt.html#showloading)
* [api/ui/prompt.html#hideloading](https://zh.uniapp.dcloud.io/api/ui/prompt.html#hideloading)
* [api/router.html#switchtab](https://zh.uniapp.dcloud.io/api/router.html#switchtab)
* [@escook/request-miniprogram](https://www.npmjs.com/package/@escook/request-miniprogram)
* [页面生命周期 —— uni-app](https://zh.uniapp.dcloud.io/tutorial/page.html#lifecycle)