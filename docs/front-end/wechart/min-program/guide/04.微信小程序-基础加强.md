# 微信小程序-基础加强

目标：

* 自定义小程序组件
* 小程序组件中的 behaviors 的作用
* 安装和配置 vant-weapp 组件库
* MobX 全局数据共享
* 小程序 API 的 Promise 化

目录：

* 自定义组件
* 使用 npm 包
* 全局数据共享
* 分包

## 1. 自定义组件

### 1.1. 组件的创建和引用

创建组件（header）的步骤：

1. 创建 `/components/header` 目录
2. 在 header 目录上右击，选择 “新建 Component” 后，输入组件名称 “header”
3. 微信开发者工具会自动创建组件相关文件

    ```text
    proj/
      components/
        header/
          header.js
          header.json
          header.wxml
          header.wxss
    ```


引用组件：

* 局部引用：当前页面内有效
* 全局引用：所有页面内有效

局部引用组件：

1. 在 `[页面.json].usingComponents` 中引用组件

    ```json
    {
      "usingComponents": {
        "my-header": "/components/header/header"
      }
    }
    ```

2. 在 `页面.wxml` 中使用组件

    ```html
    <!--pages/home/home.wxml-->
    <my-header></my-header>
    ```

全局引用组件：

1. 在 `[app.json].usingComponents` 中引用组件

    ```json
    {
      "usingComponents": {
        "my-body": "/components/body/body"
      }
    }
    ```

2. 在 `页面.wxml` 中使用组件

    ```html
    <!--pages/home/home.wxml-->
    <my-body></my-body>
    ```

组件和页面的区别：

1. `[组件.json]`

    ```json
    {
      // 额外的 component 属性，标记其为 component
      "component": true
    }
    ```

2. `[组件.js]`

    ```javascript
    // 使用 Component()， 而非 Page()
    Component({

      // 事件处理函数需要定义在 methods 选项里
      methods: {}
    })
    ```

### 1.2. 样式

组件样式隔离：

* 组件 A 的样式 不会影响 组件 C 的样式
* 组件 A 的样式 不会影响 小程序页面的样式
* 小程序页面的样式 不会影响 组件 A 的样式

组件样式隔离注意点：

* `app.wxss` 中的 class 选择器对组件 无效
* `app.wxss` 中的 id 选择器、属性选择器、标签选择器对组件 有效

修改组件的样式隔离选项：

* 修改位置

    ```javascript
    // `组件.js` 中修改
    Component({
      options: {
        styleIsolation: "apply-shared"
      }
    })

    // 组件.json` 中修改
    {
      "styleIsolation": "apply-shared"
    }
    ```

* 可选值：

  * `isolated`: 启用样式隔离，在自定义组件内外，使用 class 指定的样式将不会相互影响（一般情况下的默认值）
  * `apply-shared`: 表示页面 wxss 样式将影响到自定义组件，但自定义组件 wxss 中指定的样式不会影响页面；
  * `shared`: 表示页面 wxss 样式将影响到自定义组件，自定义组件 wxss 中指定的样式也会影响页面和其他设置了 apply-shared 或 shared 的自定义组件。（这个选项在插件中不可用。）

* 参考：[miniprogram/dev/framework/custom-component/wxml-wxss.html](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html#%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB)

### 1.3. 数据、方法、属性

data 数据：

* 定义：

    ```javascript
    Component({
      data: {
        count: 1,
      }
    })
    ```

* 读、写：

    ```javascript
    // 读
    this.data.count
    // 写
    this.setData({ count: 2 })
    ```


methods 方法：

* 事件处理函数、自定义方法 都要定义到 method 选项中：

    ```javascript
    Component({
      data: {
        count: 1,
      },
      methods: {
        // 事件处理函数
        handleTapButton() {
          this.setData({
            count: this.data.count + 1
          });

          this._showCount();
        },

        // 自定义方法，建议使用 “_” 打头
        _showCount() {
          wx.showToast({
            title: `当前 count: ${ this.data.count }`,
          })
        }
      }
    })
    ```

properties 属性：

* 说明：用于接受外界传递给组件的数据，类比 vue 中的属性传参
* 定义：

    ```javascript
    Component({
      properties: {
        // 完整写法
        max: {
          type: Number, // 类型
          value: 10,    // 默认值
        },

        // 简化写法
        step: Number,   // 默认为 0
      },

      methods: {
        handleTapButton() {
          // 读
          this.properties.max; 

          // 写
          this.setData({
            max: 20,
          });
        }
      },
    });
    ```

* 使用

    ```html
    <my-component max="9"></<my-component>>
    ```

data 和 properties 的区别：

* `this.data` 和 `this.properties` 指向同一个对象

    ```javascript
    Component({
      data: {
        count: 1,
      },
      properties: {
        max: {
          type: Number,
          value: 10,
        },
      },
      methods: {
        handleTapButton() {
          console.log(this.data);       // {count: 1, max: 10}
          console.log(this.properties); // {count: 1, max: 10}
          console.log(this.data === this.properties); // true
        },
      }
    })
    ```

* properties 里的属性也可以在模板中直接使用

### 1.4. 数据监听器

说明：

* 监听 属性和数据 字段的变化
* 类比 vue 的 watch

基本语法：

* 组件.js:

    ```javascript
    Component({
      data: {
        num1: 0,
      },
      properties: {
        num2: Number,
      },
      observers: {
        // 多个字段用英文逗号分隔
        'num1, num2': function(newNum1, newNum2) {
          // ...
        }
      },
    });
    ```

示例：

* 组件.wxml:

    ```html
    <view>{{ num1 }} + {{ num2 }} = {{ sum }}</view>

    <button bindtap="handleTapButton1">num1++</button>
    <button bindtap="handleTapButton2">num2++</button>
    ```
  
* 组件.js:

    ```javascript
    // components/header/header.js
    Component({
      data: {
        num1: 0,
        sum: 0,
      },
      properties: {
        num2: {
          type: Number,
          value: 0,
        },
      },
      observers: {
        'num1, num2': function(newNum1, newNum2) {
          this.setData({ sum: newNum1 + newNum2});
        },
      },
      methods: {
        handleTapButton1() {
          this.setData({ num1: this.data.num1 + 1 });
        },
        handleTapButton2() {
          this.setData({ num2: this.data.num2 + 1 });
        },
      }
    })
    ```  

监听对象的属性：

* 可以监听对象的 单个、多个、所有 的属性变化
    
    ```javascript
    Component({
      data: {
        person: { name: '张三', age: 18, gender: '男' }
      },
      observers: {
        /*
          单个属性

          触发情况：
            this.setData({ 'person.name': 'ZS' })   // 修改 对象的属性
            this.setData({ person: {} })            // 修改 对象
        */
        'person.name': function (newName) {
          // ...
        },

        // 多个属性
        'person.name, person.age': function (newName, newAge) {
          // ...
        },

        // 所有属性，使用通配符 ** 监听对象所有的属性
        'person.**': function (obj) {
          // obj.name
          // obj.age
          // obj.gender
        },

      }
    });
    ```

### 1.5. 纯数据字段

纯数据字段：

* 概念：不用于界面渲染的 data 字段
* 应用：某些 data 中的字段既不会展示在界面上，也不会传递给其他组件，仅在当前组件内部使用，可用定义为纯数据字段
* 好处：提升页面更新的性能

使用：

* 符合 `options.pureDataPattern` 正则的数据字段为 纯数据字段

    ```javascript
    Component({
      options: {
        // 以 _ 打头的数据字段为 纯数据字段
        pureDataPattern: /^_/,
      },

      data: {
        // 纯数据字段
        _isLoading: false,

        // 普通数据字段
        list: [],
      }
    })
    ```

### 1.6. 组件的生命周期
