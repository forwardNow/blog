# webpack 高级

[[toc]]

优化 webpack:

1. 提升开发体验
2. 提升打包构建速度
3. 减少代码体积
4. 优化代码运行性能

## 1. SourceMap

介绍：

* 浏览器运行的是 webpack 编译后的代码，很难看懂
* 一旦出错，报错位置 是 编译后的文件的出错代码位置，定位到源码位置比较困难
* SourceMap 就是编译后的代码与源代码的映射，运行的代码一旦出错，就可以定位到源代码错误位置的行和列

配置：

```javascript
module.exports = {
  mode: 'development',
  /*
    优点：打包编译速度快，只包含行映射
    缺点：没有列映射
   */
  devtool: 'cheap-module-source-map',
  // ...
};

module.exports = {
  mode: 'production',
  /*
    优点：包含行/列映射
    缺点：打包编译速度更慢
   */
  devtool: 'source-map',
  // ...
};
```

参考：[devtool](https://webpack.js.org/configuration/devtool/)

## 2. 提升打包构建速度

### 2.1. HMR ( HotModuleReplacement )

说明：

* HotModuleReplacement （HMR/热模块替换）
* 在程序运行中，替换、添加或删除模块，而无需重新加载整个页面。

CSS 热替换：

* 配置

  ```javascript
  devServer = {
    // ...
    hot: true, // 默认已开启
  }
  ```

* style-loader 已经实现热替换接口，一旦样式发生变化，就用新的 `<style>` 替换掉旧的。

JS 热替换：

* 默认情况下，一旦更改 JS 代码，就会刷新页面
* 手动将某个模块添加到热替换

  ```javascript
  if (module.hot) {
    // 一旦 sum.js 发生变化，就会将新模块重新执行一次
    // 如果此模块有副作用，就会出问题
    module.hot.accept('./js/sum');
  }
  ```

### 2.2. oneOf

说明：

* 打包时每个文件都要把所有 rule.test 过一遍，看是否匹配，匹配则执行相应 loader
* oneOf 用于，一旦匹配第一个就停止，不再继续匹配下去

配置：

```javascript
module.rules = [
  // 把所有规则包在一个 rule 里，用 oneOf
  {
    oneOf: [
      { test: /\.css$/, /* ... */  },
      { test: /\.less$/, /* ... */  },
      { test: /\.(png|jpe?g|gif|webp)$/, /* ... */  },
      { test: /\.(ttf|woff2?)$/, /* ... */  },
      // ...
    ]
  }
]
```

备注：

* 针对文件特别多的项目，打包速度是有提升的

参考：

* [Rule.oneOf](https://webpack.js.org/configuration/module/#ruleoneof)

### 2.3. include / exclude

npm 安装的第三方库都在 node_modules 里，这些文件通常都是编译好的，不需要我们额外编译。

src 目录下的才是真正需要处理的。

以下两个配置，只能选择一个：

* include: 包含
* exclude: 排除


include/exclude 值：

* string: To match the input must start with the provided string. I. e. an absolute directory path, or absolute path to the file.
* RegExp: It's tested with the input.
* function: It's called with the input and must return a truthy value to match.
* array: At least one of the Conditions must match.
* object: All properties must match. Each property has a defined behavior.
  * `{ and: [Condition] }`: All Conditions must match.
  * `{ or: [Condition] }`: Any Condition must match.
  * `{ not: [Condition] }`: All Conditions must NOT match.

示例：

```javascript
module.rules = [
  { include: path.resolve(ROOT_PATH, './src'), },
  { exclude: /node_modules/, },
  { exclude: (...args) => { /* ... */ return true; } },
  {
    include: [
      path.resolve(ROOT_PATH, './src'),
      /node_modules[/\]xyz/
    ]
  },
  {
    include: {
      and: [/* ... */],
      or: [/* ... */],
      not: [/* ... */],
    }
  }
]
```

参考：

* [Condition](https://webpack.js.org/configuration/module/#condition)
* [Rule.include](https://webpack.js.org/configuration/module/#ruleinclude)
* [Rule.exclude](https://webpack.js.org/configuration/module/#ruleexclude)

### cache

### thead
