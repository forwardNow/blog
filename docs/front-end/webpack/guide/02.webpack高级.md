# webpack 高级

优化 webpack:

1. 提升开发体验
2. 提升打包构建速度
3. 减少代码体积
4. 优化代码运行性能

## 1. SourceMap

介绍：

* 浏览器运行的是 webpack 编译后的代码，很难看懂
* 一旦出错，报错位置 是 编译后的文件的出错代码位置，定位到源码位置比较困难
* SourceMap 就是编译后的代码与源代码的映射，运行的代码一旦出错，就可以定位到源代码错误位置的行和列

配置：

```javascript
module.exports = {
  mode: 'development',
  /*
    优点：打包编译速度快，只包含行映射
    缺点：没有列映射
   */
  devtool: 'cheap-module-source-map',
  // ...
};

module.exports = {
  mode: 'production',
  /*
    优点：包含行/列映射
    缺点：打包编译速度更慢
   */
  devtool: 'source-map',
  // ...
};
```

参考：[devtool](https://webpack.js.org/configuration/devtool/)

## 2. 提升打包构建速度

### 2.1. HMR

说明：

* HotModuleReplacement （HMR/热模块替换）
* 在程序运行中，替换、添加或删除模块，而无需重新加载整个页面。

CSS 热替换：

* 配置

  ```javascript
  devServer = {
    // ...
    hot: true, // 默认已开启
  }
  ```

* style-loader 已经实现热替换接口，一旦样式发生变化，就用新的 `<style>` 替换掉旧的。

JS 热替换：

* 默认情况下，一旦更改 JS 代码，就会刷新页面
* 手动将某个模块添加到热替换

  ```javascript
  if (module.hot) {
    // 一旦 sum.js 发生变化，就会将新模块重新执行一次
    // 如果此模块有副作用，就会出问题
    module.hot.accept('./js/sum');
  }
  ```

### 2.2. oneOf

说明：

* 打包时每个文件都要把所有 rule.test 过一遍，看是否匹配，匹配则执行相应 loader
* oneOf 用于，一旦匹配第一个就停止，不再继续匹配下去

配置：

```javascript
module.rules = [
  // 把所有规则包在一个 rule 里，用 oneOf
  {
    oneOf: [
      { test: /\.css$/, /* ... */  },
      { test: /\.less$/, /* ... */  },
      { test: /\.(png|jpe?g|gif|webp)$/, /* ... */  },
      { test: /\.(ttf|woff2?)$/, /* ... */  },
      // ...
    ]
  }
]
```

备注：

* 针对文件特别多的项目，打包速度是有提升的

参考：

* [Rule.oneOf](https://webpack.js.org/configuration/module/#ruleoneof)

### 2.3. include / exclude

npm 安装的第三方库都在 node_modules 里，这些文件通常都是编译好的，不需要我们额外编译。

src 目录下的才是真正需要处理的。

以下两个配置，只能选择一个：

* include: 包含
* exclude: 排除


include/exclude 值：

* string: To match the input must start with the provided string. I. e. an absolute directory path, or absolute path to the file.
* RegExp: It's tested with the input.
* function: It's called with the input and must return a truthy value to match.
* array: At least one of the Conditions must match.
* object: All properties must match. Each property has a defined behavior.
  * `{ and: [Condition] }`: All Conditions must match.
  * `{ or: [Condition] }`: Any Condition must match.
  * `{ not: [Condition] }`: All Conditions must NOT match.

示例：

```javascript
module.rules = [
  { include: path.resolve(ROOT_PATH, './src'), },
  { exclude: /node_modules/, },
  { exclude: (...args) => { /* ... */ return true; } },
  {
    include: [
      path.resolve(ROOT_PATH, './src'),
      /node_modules[/\]xyz/
    ]
  },
  {
    include: {
      and: [/* ... */],
      or: [/* ... */],
      not: [/* ... */],
    }
  }
]
```

参考：

* [Condition](https://webpack.js.org/configuration/module/#condition)
* [Rule.include](https://webpack.js.org/configuration/module/#ruleinclude)
* [Rule.exclude](https://webpack.js.org/configuration/module/#ruleexclude)

### 2.4. cache

说明：

* 缓存 eslint 检查结果、babel 的编译结果，再次打包速度会更快

配置：

```javascript
module.rules = [
  // ...
  {
    test: /\.js$/,
    loader: 'babel-loader',
    options: {
      /*
        the default cache directory in node_modules/.cache/babel-loader
        Default false
      */
      cacheDirectory: true,
      /*
        When set, each Babel transform output will be compressed with Gzip
        Default true
      */ 
      cacheCompression: false,
    },
  },
]

plugins = [
  new ESLintWebpackPlugin({
    /*
      The cache is enabled by default to decrease execution time.
    */
    cache: true,
    /*
      Specify the path to the cache location. Can be a file or a directory.
      Default: node_modules/.cache/eslint-webpack-plugin/.eslintcache
    */
    cacheLocation: path.resolve(ROOT_PATH, './node_modules/.cache/.eslintcache'),
  }),
]
```

参考：

* [babel-loader/#options](https://webpack.js.org/loaders/babel-loader/#options)
* [eslint-webpack-plugin/#options](https://webpack.js.org/plugins/eslint-webpack-plugin/#options)


### 2.5. thead

说明：

* 提升打包速度，就是提升处理 JS 的速度
* JS 的处理，主要涉及的工具 —— eslint、babel、Terser(JS 压缩，已内置，生产默认开启)
* 可以开启多线程同时使用这些工具处理 JS

注意：

* 每个进程启动就有大约要 600ms，在特别耗时的操作中使用比较好
* 可以启动的进程数，就是 CPU 的核数

  ```javascript
  const os = require('os');

  const threads = os.cpus().length;

  console.log('CPU 核数：', threads); // 4
  ```

安装：

```shell
npm i -D thread-loader

## "thread-loader": "^4.0.1",
```

配置：

```javascript
const os = require('os');
const TerserPlugin = require('terser-webpack-plugin');

const THREADS = os.cpus().length - 1;

module.exports = {
  // ...
  module: {
    rules: [
      // ...
      {
        test: /\.js$/,
        use: [
          {
            /*
              Runs the following loaders in a worker pool.
            */
            loader: 'thread-loader',
            options: {
              /*
                the number of spawned workers, 
                defaults to (number of cpus - 1) 
                or fallback to 1 when require('os').cpus() is undefined
              */
              workers: THREADS,
            },
          },
          { loader: 'babel-loader' },
        ],
      },
    ]
  },

  plugins: [
    new ESLintWebpackPlugin({
      /*
      Will run lint tasks across a thread pool. 
      The pool size is automatic unless you specify a number.
        Default: false
      */
      threads: THREADS, // boolean | number
    }),
    
  ],

  optimization: {
    // 压缩相关的放这里
    minimizer: [
      /*
        生产模式下，已开启此插件，额外配置的话就需要重新写
      */
      new TerserPlugin({
        /*
          Use multi-process parallel running to improve the build speed.
            Default: true. 
            Default number of concurrent runs: os.cpus().length - 1
        */
        parallel: THREADS, // boolean | number
      }),
    ],
  },
}
```

参考：

* [thread-loader](https://webpack.js.org/loaders/thread-loader/)
* [terser-webpack-plugin](https://webpack.js.org/plugins/terser-webpack-plugin/)
* [eslint-webpack-plugin/#threads](https://webpack.js.org/plugins/eslint-webpack-plugin/#threads)

## 3. 减少代码体积

### 3.1. Tree Shaking

说明：

* 摇树，移除未使用的 JS 代码
* 特别是第三方 工具函数库、组件库，我们只使用了极少部分，却引入了全部
* webpack 默认已开启此功能
* 针对 ES Module

参考：

* [tree-shaking](https://webpack.js.org/guides/tree-shaking)

### 3.2. Babel

说明：

* 默认情况下，babel 会给所有编辑的文件添加相同的辅助代码（运行时代码），如 `_extend`
* 可以使用 `@babel/plugin-transform-runtime` 插件，将运行时代码作为一个单独的模块引入，避免为每个编译的文件都引入

安装：

```shell
npm i -D @babel/plugin-transform-runtime

## "@babel/plugin-transform-runtime": "^7.21.4",
```

配置：(`babel.config.js`)

```javascript
module.exports = {
  presets: [ '@babel/preset-env' ],
  plugins: [ 
    /*
      A plugin that enables the re-use of Babel's injected helper code to save on codesize.
    */
    '@babel/plugin-transform-runtime' 
  ]
};
```

参考：

* [@babel/plugin-transform-runtime](https://babeljs.io/docs/babel-plugin-transform-runtime/)

### 3.3. Image Minimizer

说明：

* 压缩图片

安装：

```shell
# image-minimizer-webpack-plugin 使用 imagemin 工具
npm i -D image-minimizer-webpack-plugin imagemin

    ## "image-minimizer-webpack-plugin": "^3.8.2",
    ## "imagemin": "^8.0.1",

# imagemin 使用以下插件处理图片

# gif svg
npm i -D imagemin-gifsicle imagemin-svgo

    ## "imagemin-gifsicle": "^7.0.0",
    ## "imagemin-svgo": "^10.0.1",

# 无损压缩 (jpg png)
npm i -D  imagemin-jpegtran imagemin-optipng 

    ## "imagemin-jpegtran": "^7.0.0",
    ## "imagemin-optipng": "^8.0.0",

# 有损压缩 (jpg png)
npm i -D  imagemin-mozjpeg imagemin-pngquant
```

配置：

```javascript
const ImageMinimizerPlugin = require('image-minimizer-webpack-plugin');

optimization.minimizer = [
  // ...
  new ImageMinimizerPlugin({
    minimizer: {
      implementation: ImageMinimizerPlugin.imageminGenerate,
      options: {
        plugins: [
          ['gifsicle', { interlaced: true }],
          ['jpegtran', { progressive: true }],
          ['optipng', { optimizationLevel: 5 }],
          [
            'svgo',
            {
              plugins: [
                'preset-default',
                'prefixIds',
                {
                  name: 'sortAttrs',
                  params: {
                    xmlnsOrder: 'alphabetical',
                  },
                },
              ],
            },
          ],
        ],
      },
    },
  }),
]
```

备注：

* 安装包时，如果出现 `jpegtran.exe`、`optipng.exe` 找不到，可以到官网下载，然后放到指定目录

参考：

* [image-minimizer-webpack-plugin](https://webpack.js.org/plugins/image-minimizer-webpack-plugin/)
* [jpegtran 官网地址](http://jpegclub.org/jpegtran/)
* [OptiPNG 官网地址](http://optipng.sourceforge.net/)

## 4. 优化代码运行性能

### 4.1. Code Split

说明：

* 将所有 JS 文件打包到一个文件中，体积太大了，使加载时间变长了
* code split
  * 分割文件：将打包的文件分成多个
  * 按需加载：需要哪个就加载哪个

分类：

* 多页面（多入口）
* 单页面（单入口）

module、chunk、bundle：

* module: ESM、CommonJS
* chunk: 1. 入口点; 2. 异步载入(`import()`); 3. `splitChunks.cacheGroups.{cacheGroup}`
* bundle: 最终生成的文件

参考：

* [Webpack 理解 Chunk](https://juejin.cn/post/6844903889393680392)

#### 4.1.1. 多页面

目录：

```text
public/
  about-us.html
  home.html
src/
  home/
    home.js
  about-us/
    about-us.js
  common/
    common.js
webpack.config.js
```

##### 4.1.1.1. 配置多页面

配置:

```javascript
const { resolve } = require("path");
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  mode: 'production',

  entry: {
    home: './src/home/home.js',
    'about-us': './src/about-us/about-us.js'
  },

  output: {
    path: resolve(__dirname, './dist'),
    filename: 'js/[name].js',
    clean: true,
  },

  plugins: [
    new HtmlWebpackPlugin({
      template: resolve(__dirname, './public/home.html'),
      filename: 'home.html',
      chunks: ['home'],
    }),
    new HtmlWebpackPlugin({
      template: resolve(__dirname, './public/about-us.html'),
      filename: 'about-us.html',
      chunks: ['about-us'],
    }),
  ]
}
```

##### 4.1.1.2. 提取公共模块

配置：

```javascript
module.exports = {
  // ...
  optimization: {
    splitChunks: {
      //#region default for group
      chunks: 'all',  // 'async', 'all', 'initial'
      // minSize: 20000, // Minimum size, in bytes, for a chunk to be generated.
      // minRemainingSize: 0, // 被拆后的 main.js 大小，开发为0，生成为 minSize
      // minChunks: 1, // 在拆之前，被引用的次数
      // maxAsyncRequests: 30, // 按需加载时的最大并行请求数。
      // maxInitialRequests: 30, // 入口的最大并行请求数。
      // enforceSizeThreshold: 50000, // 大于 50KB 就强制拆
      //#endregion

      cacheGroups: {  
        commons: {  // common chunk
          priority: 1, // 优先级，默认 0
          reuseExistingChunk: true,
          test: /[\\/]node_modules[\\/]/,
          // cacheGroupKey here is `commons` as the key of the cacheGroup
          name(module, chunks, cacheGroupKey) {
            const moduleFileName = module
              .identifier()
              .split(/[/\\]/)
              .reduceRight((item) => item);

            console.log(moduleFileName)

            const allChunksNames = chunks.map((item) => item.name).join('~');
            return `${cacheGroupKey}-${allChunksNames}-${moduleFileName}`;
          },
        },

        default: { // default chunk 
          priority: -20,
          minSize: 0, // 未匹配到的模块都会进入这个 
          reuseExistingChunk: true,
        }
      }
    }
  },
}
```

参考：

* [split-chunks-plugin/#splitchunksminsize](https://webpack.js.org/plugins/split-chunks-plugin/#splitchunksminsize)

##### 4.1.1.3. 按需加载

说明：

* 需要的时候再载入该模块

使用：

```javascript
import('../common/math').then(({ add }) => {
  console.log(add(1, 2))
})
```

#### 单页面

### Preload / Prefetch

### Network Cache

### core-js

### PWA

