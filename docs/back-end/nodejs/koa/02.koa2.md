# koa2

* koa2 的介绍
* koa2 快速上手
* 后台项目

## 1. 介绍

说明：

* 基于 Node.js 平台的 web 开发框架
* 由 Express 原班人马打造

Web框架比较：

| web框架   | 异步处理              |
|---------|-------------------|
| Express | 回调函数              |
| koa     | Generator + yield |
| koa2    | async / await     |

特点：

* 支持 async/await (node v7.6+)
* 洋葱模型的中间件
  * ![koa2_middleware](./images/koa2_middleware.png)

## 2. 快速上手

安装：

```shell
npm i koa
```

目录结构：

```text
${root}/
    app.js
```

app.js:

```javascript
// codes/backend/nodejs/koa2/01-quick-start/app.js
const Koa = require('koa');

const app = new Koa();

// 调用 next() 则执行下一个中间件
app.use((ctx, next) => {
  console.log(ctx.request.url);
  ctx.response.body = 'hello world';
});

app.listen(3000);
```

访问： 

* http://localhost:3000/

中间件的特点：

* 通过 `koaIns.use()` 应用中间件
* 一个中间件就是一个函数
* 中间件的执行顺序符合洋葱模型
* 需要调用 `next()` 方法才会执行下一个中间件

中间件示例：

```javascript
// codes/backend/nodejs/koa2/01-quick-start/app_onion.js
const Koa = require('koa');

const app = new Koa();

app.use(async (ctx, next) => {
  console.log('step 1');
  ctx.response.body = 'hello world';

  const result = await next();

  console.log(`step 4`, result); // 中间件 2 返回的值

  return '中间件 1 返回的值';
});

app.use(async (ctx, next) => {
  console.log('step 2');

  const result = await next();

  console.log('step 3', result); // undefined

  return '中间件 2 返回的值';
});

app.listen(3000);
```

## 3. 后台项目

目标：

* 计算处理请求的耗时
* 设置 MIME 类型
* 根据 URL 读取文件内容

步骤：

1. 项目准备
2. 总耗时中间件
3. 响应头中间件
4. 业务逻辑中间件

### 3.1. 项目准备

安装依赖：
  
```shell
npm init -y
npm install koa
```
 
文件及目录结构：

```text
${root}/
  app.js
  data/
    seller.json
  middleware/
    koa_response_data.js
    koa_response_duration.js
    koa_response_header.js
  utils/
    file_utils.js
```

### 3.2. 总耗时中间件

说明：

* 第 1 层中间件
* 计算执行时间， `next()` 前后的时间差
* 设置响应头： `x-response-time: 5ms`

示例：

```javascript
// codes/backend/nodejs/koa2/02-server/middleware/koa_response_duration.js
module.exports = async (ctx, next) => {
  const start = Date.now();

  await next();

  const end = Date.now();

  const duration = end - start;
  ctx.set('x-response-time', `${duration}ms`);
};
```

### 3.3. 响应头中间件

说明：

* 第 2 层中间件
* 设置 `content-type: application/json;charset=UTF-8`
* 允许跨域

示例：

```javascript
// codes/backend/nodejs/koa2/02-server/middleware/koa_response_header.js
module.exports = async (ctx, next) => {
  const contentType = 'application/json;charset=utf-8';

  ctx.set('content-type', contentType);

  ctx.set('Access-Control-Allow-Origin', '*');
  ctx.set('Access-Control-Allow-Methods', 'PUT, POST, GET, DELETE, OPTIONS');

  await next();
};
```

### 3.4. 业务逻辑中间件

说明：

* 第 3 层
* 根据 URL 读取文件

接口：

| 接口              | 说明   |
|-----------------|------|
| /api/seller     | 商家销量 |
| /api/budget     | 预算开销 |
| /api/stock      | 库存信息 |
| /api/trend      | 销量趋势 |
| /api/rank       | 销量排行 |
| /api/map        | 商家分布 |
| /api/hotproduct | 热销商品 |

示例：

```javascript
// codes/backend/nodejs/koa2/02-server/middleware/koa_response_data.js
const fs = require('fs');
const path = require('path');

module.exports = async (ctx, next) => {
  let response = {};
  try {
    const json = getJsonFileByUrl(ctx.request.url);
    response = { status: 200, data: json };
  } catch (e) {
    response = { status: 500, message: '读取文件失败' };
  }

  ctx.response.body = JSON.stringify(response);
  await next();
};

function getJsonFileByUrl(url) {
  const filePath = getFilePathByUrl(url);
  const fileContent = fs.readFileSync(filePath, { encoding: 'utf8' });
  const json = JSON.parse(fileContent);
  return json;
}

// /api/seller  -> ../data/seller.json
function getFilePathByUrl(url) {
  const lastName = url.replace('/api/', ''); // /api/seller -> seller
  return path.join(__dirname, '../data', `${lastName}.json`);
}
```
