# koa2-快速入门

## 1. 安装

```shell
npm i koa

## "koa": "^2.14.2"
```

## 2. 第一个应用

目录：

```text
proj/
  src/
    app.js  
```

app.js:

```js
const Koa = require('koa');
const app = new Koa();

app.use(async ctx => {
  ctx.body = 'Hello World';
});

app.listen(3000);
```

访问：

* `http://localhost:3000/`

## 3. 中间件

特点：

* 通过 `koaIns.use()` 应用中间件
* 一个中间件就是一个函数
* 中间件的执行顺序符合洋葱模型
* 需要调用 `next()` 方法才会执行下一个中间件

示例：

```js
const Koa = require('koa');

const app = new Koa();

app.use(async (ctx, next) => {
  console.log('step 1');
  ctx.response.body = 'hello world';

  const result = await next();

  console.log(`step 4`, result); // 中间件 2 返回的值

  return '中间件 1 返回的值';
});

app.use(async (ctx, next) => {
  console.log('step 2');

  const result = await next();

  console.log('step 3', result); // undefined

  return '中间件 2 返回的值';
});

app.listen(3000, () => {
  console.log('server is started: http://localhost:3000')
});
```

## 4. 路由

### 4.1. 基本使用

说明：

* 使用 koa-router

安装：

```shell
npm i @koa/router

## "@koa/router": "^12.0.0",
```

使用：

```js
const Koa = require('koa');
const Router = require('@koa/router');

const app = new Koa();
const router = new Router();

router.get('/', (ctx, next) => {
    ctx.body = 'Hello World';
});

router.post('/updateUser', (ctx, next) => {
  // ...
});

app
  .use(router.routes())
  .use(router.allowedMethods());
```

### 4.2. 参数

```js
/*
  query 参数
    http://localhost:3000/getUser?id=1
 */
ctx.request.query


/*
  body 参数
 */
ctx.request.body


/*
  动态路由参数
    http://localhost:3000/user/2
    
    router.get('/user/:id', ...)
 */
ctx.params
```

### 4.3. GET

query 传参：

```js
/*
请求：
  http://localhost:3000/getUser?id=1

响应：
  Content-Type: application/json; charset=utf-8

  {
    "id": 1,
    "name": "张三"
  }
 */
router.get('/getUser', (ctx, next) => {
  const { query } = ctx.request;

  // { id: '1' }
  console.log('query: ', query);

  ctx.response.body = { id: 1, name: '张三' };
})
```

动态路由传参：

```js
/*
请求：
  http://localhost:3000/user/2

响应：
  Content-Type: application/json; charset=utf-8

  {
      "id": 2,
      "name": "李四"
  }
 */
router.get('/user/:id', (ctx, next) => {
  const { params } = ctx;

  // { id: '2' }
  console.log('params: ', params);

  ctx.response.body = { id: 2, name: '李四' };
})
```

## 5. 参考

* [koa 官网](https://koajs.com/)
* [koa获取参数的三种方式](https://juejin.cn/post/6844904114405507080)
* [koa2：统一接口返回数据格式](https://blog.csdn.net/qq_40963664/article/details/109217605)
