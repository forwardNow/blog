<!--#region
@author 吴钦飞
@email wuqinfei@qq.com
@create date 2025-11-23 11:35:34
@modify date 2025-11-23 13:08:28
@desc [description]
#endregion-->

# Java 并发

## 1. CompletableFuture

工具类:

```java
public class SmallTool {
    public static void sleepMillis(long millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

    public static void printTimeAndThread(String tag) {
        String result = new StringJoiner("\t|\t")
                .add(String.valueOf(System.currentTimeMillis()))
                .add(String.valueOf(Thread.currentThread().getId()))
                .add(Thread.currentThread().getName())
                .add(tag)
                .toString();
        System.out.println(result);
    }
}
```

### 1.1. supplyAsync 开启

```java
@Test
public void 开启_异步方法() {
    SmallTool.printTimeAndThread("小明 点餐: 番茄炒蛋 + 米饭");

    // 启动方法
    CompletableFuture<String> completableFuture = CompletableFuture.supplyAsync(() -> {
        SmallTool.printTimeAndThread("厨师 炒菜");
        SmallTool.sleepMillis(300);
        SmallTool.printTimeAndThread("厨师 打饭");
        SmallTool.sleepMillis(200);
        return "番茄炒蛋 + 米饭 做好了";
    });

    SmallTool.printTimeAndThread("小明 打游戏");

    // 等待异步执行完毕
    String result = completableFuture.join();

    SmallTool.printTimeAndThread(String.format("%s, 小明吃饭", result));
}
```

### 1.2. thenCompose 连接

```java
@Test
public void 连接_多个异步方法串行执行() {
    SmallTool.printTimeAndThread("小明 点餐: 番茄炒蛋 + 米饭");

    // 厨师炒完菜，服务员才去打饭，然后组合 菜和饭
    CompletableFuture<String> completableFuture = CompletableFuture.supplyAsync(() -> {
        SmallTool.printTimeAndThread("厨师 炒菜");
        SmallTool.sleepMillis(300);
        return "番茄炒蛋";
    }).thenCompose((dish) -> CompletableFuture.supplyAsync(() -> {
        SmallTool.printTimeAndThread("服务员 打饭");
        SmallTool.sleepMillis(200);
        return String.format("%s + 米饭 做好了", dish);
    }));

    SmallTool.printTimeAndThread("小明 打游戏");

    String result = completableFuture.join();

    SmallTool.printTimeAndThread(String.format("%s, 小明吃饭", result));
}
```

### 1.3. thenCombine 合并

```java
@Test
public void 合并_多个异步方法并发执行() {
    SmallTool.printTimeAndThread("小明 点餐: 番茄炒蛋 + 米饭");

    // 厨师炒菜、服务员煮饭 同时进行，等都完毕后，再组合 菜和饭
    CompletableFuture<String> completableFuture = CompletableFuture.supplyAsync(() -> {
        SmallTool.printTimeAndThread("厨师 炒菜");
        SmallTool.sleepMillis(300);
        return "番茄炒蛋";
    }).thenCombine(CompletableFuture.supplyAsync(() -> {
        SmallTool.printTimeAndThread("服务员 煮饭");
        SmallTool.sleepMillis(200);
        return "米饭";
    }), (dish, rice) -> {
        SmallTool.printTimeAndThread("服务员 打饭");
        SmallTool.sleepMillis(100);
        return String.format("%s + %s 做好了", dish, rice);
    });

    SmallTool.printTimeAndThread("小明 打游戏");

    String result = completableFuture.join();

    SmallTool.printTimeAndThread(String.format("%s, 小明吃饭", result));
}
```
